<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Fylge</title>
        <script src="https://unpkg.com/globe.gl@2.27.2/dist/globe.gl.min.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Oxygen, Ubuntu, sans-serif;
                background: #000;
                color: #fff;
                overflow: hidden;
            }

            #globe-container {
                width: 100vw;
                height: 100vh;
            }

            #icon-palette {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                gap: 8px;
                background: rgba(0, 0, 0, 0.7);
                padding: 12px 16px;
                border-radius: 12px;
                backdrop-filter: blur(10px);
                z-index: 100;
            }

            .icon-btn {
                width: 48px;
                height: 48px;
                border: 2px solid transparent;
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.1);
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
            }

            .icon-btn:hover {
                background: rgba(255, 255, 255, 0.2);
            }

            .icon-btn.selected {
                border-color: #4fc3f7;
                background: rgba(79, 195, 247, 0.2);
            }

            .icon-btn img {
                width: 32px;
                height: 32px;
            }

            .marker {
                display: flex;
                flex-direction: column;
                align-items: center;
                transform: translate(-50%, -100%);
            }

            .marker img {
                width: 32px;
                height: 32px;
                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
            }

            .marker .label {
                font-size: 12px;
                background: rgba(0, 0, 0, 0.7);
                padding: 2px 6px;
                border-radius: 4px;
                margin-top: 4px;
                white-space: nowrap;
                max-width: 150px;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            #info {
                position: fixed;
                top: 20px;
                left: 20px;
                background: rgba(0, 0, 0, 0.7);
                padding: 12px 16px;
                border-radius: 8px;
                backdrop-filter: blur(10px);
                font-size: 14px;
                z-index: 100;
            }

            #info h1 {
                font-size: 18px;
                margin-bottom: 8px;
            }

            #info p {
                color: #aaa;
            }
        </style>
    </head>
    <body>
        <div id="globe-container"></div>

        <div id="info">
            <h1>Fylge</h1>
            <p>Select an icon, click the globe to place a marker.</p>
            <p>Markers are visible for 24 hours.</p>
        </div>

        <div id="icon-palette">
            <!-- Icons will be rendered here -->
        </div>

        <script>
            // Application state
            const STORAGE_KEY = "fylge_state";
            const POLL_INTERVAL = 3000;
            const EXPIRY_CHECK_INTERVAL = 60000;

            const state = {
                lastId: loadLastId(),
                markersByUuid: new Map(),
                selectedIconId: null,
                icons: [],
            };

            let globe = null;

            function loadLastId() {
                try {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    if (stored) {
                        const data = JSON.parse(stored);
                        return data.lastId ?? 0;
                    }
                } catch (e) {}
                return 0;
            }

            function saveLastId(lastId) {
                try {
                    localStorage.setItem(
                        STORAGE_KEY,
                        JSON.stringify({ lastId }),
                    );
                } catch (e) {}
            }

            function generateUUID() {
                return crypto.randomUUID();
            }

            // API functions
            async function apiCreateMarker(req) {
                const response = await fetch("/markers", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(req),
                });
                if (!response.ok) {
                    throw new Error(`Failed: ${response.status}`);
                }
                return response.json();
            }

            async function apiGetMarkers() {
                const response = await fetch("/api/markers");
                if (!response.ok) {
                    throw new Error(`Failed: ${response.status}`);
                }
                return response.json();
            }

            async function apiGetLog(afterId, limit = 100) {
                const response = await fetch(
                    `/api/log?after_id=${afterId}&limit=${limit}`,
                );
                if (!response.ok) {
                    throw new Error(`Failed: ${response.status}`);
                }
                return response.json();
            }

            async function apiGetIcons() {
                const response = await fetch("/api/icons");
                if (!response.ok) {
                    throw new Error(`Failed: ${response.status}`);
                }
                return response.json();
            }

            // Globe functions
            function initGlobe() {
                const container = document.getElementById("globe-container");

                globe = Globe()(container)
                    .globeImageUrl(
                        "//unpkg.com/three-globe/example/img/earth-blue-marble.jpg",
                    )
                    .bumpImageUrl(
                        "//unpkg.com/three-globe/example/img/earth-topology.png",
                    )
                    .backgroundImageUrl(
                        "//unpkg.com/three-globe/example/img/night-sky.png",
                    )
                    .htmlElementsData([])
                    .htmlElement((d) => {
                        const icon = state.icons.find(
                            (i) => i.id === d.icon_id,
                        );
                        const el = document.createElement("div");
                        el.className = "marker";
                        el.innerHTML = `
            <img src="${icon?.url ?? "/static/icons/marker.svg"}" alt="${d.icon_id}" />
            ${d.label ? `<span class="label">${d.label}</span>` : ""}
          `;
                        el.style.pointerEvents = "auto";
                        el.style.cursor = "pointer";
                        el.title = d.label ?? d.uuid;
                        return el;
                    })
                    .htmlLat((d) => d.lat)
                    .htmlLng((d) => d.lon)
                    .htmlAltitude(0.01)
                    .onGlobeClick(handleGlobeClick);

                window.addEventListener("resize", () => {
                    if (globe && container) {
                        globe.width(container.clientWidth);
                        globe.height(container.clientHeight);
                    }
                });
            }

            async function handleGlobeClick(coords) {
                if (!state.selectedIconId) {
                    console.log("No icon selected");
                    return;
                }

                const uuid = generateUUID();
                const label = prompt("Label (optional):") || undefined;

                try {
                    const response = await apiCreateMarker({
                        uuid,
                        lat: coords.lat,
                        lon: coords.lng,
                        icon_id: state.selectedIconId,
                        label,
                    });

                    console.log(`Marker ${response.status}:`, response.marker);
                    state.markersByUuid.set(
                        response.marker.uuid,
                        response.marker,
                    );
                    updateGlobeMarkers();

                    if (response.marker.id > state.lastId) {
                        state.lastId = response.marker.id;
                        saveLastId(state.lastId);
                    }
                } catch (e) {
                    console.error("Failed to create marker:", e);
                    alert("Failed to create marker. Please try again.");
                }
            }

            function updateGlobeMarkers() {
                if (!globe) return;
                const markers = Array.from(state.markersByUuid.values());
                globe.htmlElementsData(markers);
            }

            function renderIconPalette() {
                const palette = document.getElementById("icon-palette");
                palette.innerHTML = "";

                for (const icon of state.icons) {
                    const btn = document.createElement("button");
                    btn.className =
                        "icon-btn" +
                        (icon.id === state.selectedIconId ? " selected" : "");
                    btn.title = icon.name;
                    btn.innerHTML = `<img src="${icon.url}" alt="${icon.name}" />`;
                    btn.addEventListener("click", () => {
                        state.selectedIconId = icon.id;
                        renderIconPalette();
                    });
                    palette.appendChild(btn);
                }
            }

            function removeExpiredMarkers() {
                const now = new Date();
                const cutoff = new Date(now.getTime() - 24 * 60 * 60 * 1000);
                let removed = 0;

                for (const [uuid, marker] of state.markersByUuid) {
                    const markerTime = new Date(marker.ts);
                    if (markerTime < cutoff) {
                        state.markersByUuid.delete(uuid);
                        removed++;
                    }
                }

                if (removed > 0) {
                    console.log(`Removed ${removed} expired markers`);
                    updateGlobeMarkers();
                }
            }

            // Initialize
            async function init() {
                console.log("Initializing Fylge...");

                // Load icons
                try {
                    const iconsResponse = await apiGetIcons();
                    state.icons = iconsResponse.icons;
                    if (state.icons.length > 0) {
                        state.selectedIconId = state.icons[0].id;
                    }
                    renderIconPalette();
                } catch (e) {
                    console.error("Failed to load icons:", e);
                }

                // Initialize globe
                initGlobe();

                // Load initial markers
                try {
                    const response = await apiGetMarkers();
                    console.log(
                        `Loaded ${response.markers.length} markers (last 24h)`,
                    );

                    for (const marker of response.markers) {
                        state.markersByUuid.set(marker.uuid, marker);
                    }

                    state.lastId = response.max_id;
                    saveLastId(state.lastId);
                    updateGlobeMarkers();
                } catch (e) {
                    console.error("Failed to load initial markers:", e);
                }

                // Start polling
                setInterval(async () => {
                    try {
                        const response = await apiGetLog(state.lastId);
                        if (response.entries.length > 0) {
                            console.log(
                                `Poll: ${response.entries.length} new entries`,
                            );
                            for (const marker of response.entries) {
                                state.markersByUuid.set(marker.uuid, marker);
                            }
                            state.lastId = response.max_id;
                            saveLastId(state.lastId);
                            updateGlobeMarkers();
                        }
                    } catch (e) {
                        console.error("Polling error:", e);
                    }
                }, POLL_INTERVAL);

                // Start expiry check
                setInterval(removeExpiredMarkers, EXPIRY_CHECK_INTERVAL);
            }

            init().catch(console.error);
        </script>
    </body>
</html>
